{{define "dashboard-content"}}
<div class="dashboard">
    <!-- Header with Auto-refresh Controls -->
    <div class="dashboard-header">
        <h1>Dashboard</h1>
        <div class="refresh-controls">
            <label>
                <input type="checkbox" id="auto-refresh" checked>
                Auto-refresh (10s)
            </label>
            <button onclick="refreshDashboard()" class="btn btn-secondary">
                ðŸ”„ Actualizar
            </button>
        </div>
    </div>

    <!-- Metrics Grid -->
    <div class="metrics-grid" 
         hx-get="/api/metrics" 
         hx-trigger="every 10s[document.getElementById('auto-refresh').checked]"
         hx-target="#metrics-content">
        <div id="metrics-content">
            <div class="metric-card">
                <div class="metric-icon">ðŸ“Š</div>
                <div class="metric-content">
                    <div class="metric-label">Total Sensores</div>
                    <div class="metric-value">{{.Metrics.TotalSensors}}</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">ðŸ“ˆ</div>
                <div class="metric-content">
                    <div class="metric-label">Total Registros</div>
                    <div class="metric-value">{{.Metrics.TotalRecords}}</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">ðŸ’¾</div>
                <div class="metric-content">
                    <div class="metric-label">TamaÃ±o BD</div>
                    <div class="metric-value">{{.Metrics.DatabaseSize}}</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">âš¡</div>
                <div class="metric-content">
                    <div class="metric-label">Escrituras/min</div>
                    <div class="metric-value">{{printf "%.1f" .Metrics.WritesPerMinute}}</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">ðŸ“–</div>
                <div class="metric-content">
                    <div class="metric-label">Lecturas/min</div>
                    <div class="metric-value">{{printf "%.1f" .Metrics.ReadsPerMinute}}</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">ðŸ§ </div>
                <div class="metric-content">
                    <div class="metric-label">Memoria</div>
                    <div class="metric-value">{{.Metrics.MemoryUsage}}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <h3>Actividad del Sistema</h3>
            <canvas id="systemChart" width="400" height="200"></canvas>
        </div>
        
        <div class="chart-container">
            <h3>Sensores Activos</h3>
            <canvas id="sensorsChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- Sensors Status Table -->
    <div class="sensors-section">
        <div class="section-header">
            <h3>Estado de Sensores</h3>
            <div class="sensor-filters">
                <select id="status-filter" onchange="filterSensors()">
                    <option value="all">Todos los estados</option>
                    <option value="online">En lÃ­nea</option>
                    <option value="warning">Advertencia</option>
                    <option value="offline">Sin conexiÃ³n</option>
                </select>
            </div>
        </div>
        
        <div class="sensors-table-container" 
             hx-get="/api/sensors" 
             hx-trigger="every 15s[document.getElementById('auto-refresh').checked]"
             hx-target="#sensors-table">
            <table id="sensors-table" class="sensors-table">
                <thead>
                    <tr>
                        <th>Estado</th>
                        <th>Sensor ID</th>
                        <th>Ãšltimo Valor</th>
                        <th>Calidad</th>
                        <th>Ãšltima ActualizaciÃ³n</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Sensors}}
                    <tr class="sensor-row" data-status="{{.Status}}">
                        <td>
                            <span class="status-badge status-{{.Status}}">
                                {{if eq .Status "online"}}ðŸŸ¢{{else if eq .Status "warning"}}ðŸŸ¡{{else}}ðŸ”´{{end}}
                                {{.Status}}
                            </span>
                        </td>
                        <td class="sensor-id">{{.ID}}</td>
                        <td class="sensor-value">{{printf "%.2f" .LastValue}}</td>
                        <td class="sensor-quality">{{.Quality}}</td>
                        <td class="sensor-time">{{.LastUpdate.Format "15:04:05"}}</td>
                        <td class="sensor-actions">
                            <button onclick="viewSensorChart('{{.ID}}')" class="btn btn-sm">ðŸ“ˆ</button>
                            <button onclick="createAlert('{{.ID}}')" class="btn btn-sm">ðŸš¨</button>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Alerts -->
    <div class="alerts-section">
        <div class="section-header">
            <h3>Alertas Recientes</h3>
            <a href="/alertas" class="btn btn-secondary">Ver todas</a>
        </div>
        <div class="recent-alerts" 
             hx-get="/api/alerts" 
             hx-trigger="every 20s[document.getElementById('auto-refresh').checked]"
             hx-target="#alerts-list">
            <div id="alerts-list">
                <!-- Alerts will be loaded here -->
                <div class="alert-item info">
                    <span class="alert-time">--:--:--</span>
                    <span class="alert-message">Sistema iniciado correctamente</span>
                </div>
            </div>
        </div>
    </div>

    <!-- System Info -->
    <div class="system-info">
        <div class="info-grid">
            <div class="info-item">
                <strong>Uptime:</strong> 
                <span id="uptime">{{.Metrics.UptimeSeconds}}s</span>
            </div>
            <div class="info-item">
                <strong>Ãšltima CompactaciÃ³n:</strong> 
                {{.Metrics.LastCompaction}}
            </div>
            <div class="info-item">
                <strong>Alertas Activas:</strong> 
                <span class="badge">{{.Metrics.ActiveAlerts}}</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Sensor Chart -->
<div id="sensorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Sensor Chart</h3>
            <span class="close" onclick="closeSensorModal()">&times;</span>
        </div>
        <div class="modal-body">
            <canvas id="sensorModalChart" width="600" height="300"></canvas>
        </div>
    </div>
</div>

<script>
// Dashboard JavaScript
let systemChart, sensorsChart, modalChart;

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    updateUptime();
    setInterval(updateUptime, 1000);
});

function initializeCharts() {
    // System Activity Chart
    const systemCtx = document.getElementById('systemChart').getContext('2d');
    systemChart = new Chart(systemCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Escrituras/min',
                data: [],
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.1
            }, {
                label: 'Lecturas/min',
                data: [],
                borderColor: '#2196F3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { type: 'time' },
                y: { beginAtZero: true }
            }
        }
    });

    // Sensors Status Chart
    const sensorsCtx = document.getElementById('sensorsChart').getContext('2d');
    sensorsChart = new Chart(sensorsCtx, {
        type: 'doughnut',
        data: {
            labels: ['En lÃ­nea', 'Advertencia', 'Sin conexiÃ³n'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#4CAF50', '#FF9800', '#F44336']
            }]
        },
        options: {
            responsive: true
        }
    });

    // Update charts with real data
    updateCharts();
    setInterval(updateCharts, 30000); // Update every 30 seconds
}

function updateCharts() {
    // Fetch data and update charts
    fetch('/api/metrics')
        .then(response => response.json())
        .then(data => {
            // Update system chart
            const now = new Date();
            systemChart.data.labels.push(now);
            systemChart.data.datasets[0].data.push(data.writesPerMinute);
            systemChart.data.datasets[1].data.push(data.readsPerMinute);
            
            // Keep only last 20 points
            if (systemChart.data.labels.length > 20) {
                systemChart.data.labels.shift();
                systemChart.data.datasets[0].data.shift();
                systemChart.data.datasets[1].data.shift();
            }
            
            systemChart.update();
        });

    // Update sensors chart
    fetch('/api/sensors')
        .then(response => response.json())
        .then(sensors => {
            const statusCounts = { online: 0, warning: 0, offline: 0 };
            sensors.forEach(sensor => statusCounts[sensor.status]++);
            
            sensorsChart.data.datasets[0].data = [
                statusCounts.online,
                statusCounts.warning,
                statusCounts.offline
            ];
            sensorsChart.update();
        });
}

function refreshDashboard() {
    htmx.trigger(document.body, 'refresh-dashboard');
    showNotification('Dashboard actualizado', 'success');
}

function filterSensors() {
    const filter = document.getElementById('status-filter').value;
    const rows = document.querySelectorAll('.sensor-row');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        if (filter === 'all' || status === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function viewSensorChart(sensorId) {
    document.getElementById('modalTitle').textContent = `Sensor: ${sensorId}`;
    document.getElementById('sensorModal').style.display = 'block';
    
    // Initialize modal chart if not exists
    if (!modalChart) {
        const ctx = document.getElementById('sensorModalChart').getContext('2d');
        modalChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Valor',
                    data: [],
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { type: 'time' },
                    y: { beginAtZero: false }
                }
            }
        });
    }
    
    // Load sensor data (placeholder - implement real data loading)
    loadSensorData(sensorId);
}

function closeSensorModal() {
    document.getElementById('sensorModal').style.display = 'none';
}

function createAlert(sensorId) {
    window.location.href = `/alertas?sensor=${sensorId}`;
}

function loadSensorData(sensorId) {
    // Placeholder implementation
    // In real implementation, fetch data from API and update modalChart
    showNotification(`Cargando datos para ${sensorId}`, 'info');
}

function updateUptime() {
    const uptimeElement = document.getElementById('uptime');
    if (uptimeElement) {
        const seconds = parseInt(uptimeElement.textContent);
        uptimeElement.textContent = formatUptime(seconds + 1);
    }
}

function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (days > 0) {
        return `${days}d ${hours}h ${minutes}m`;
    } else if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
    } else {
        return `${minutes}m ${secs}s`;
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('sensorModal');
    if (event.target === modal) {
        closeSensorModal();
    }
}
</script>
{{end}}