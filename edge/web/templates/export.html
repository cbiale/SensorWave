{{define "export-content"}}
<div class="export-page">
    <div class="page-header">
        <h1>Exportar Datos</h1>
        <p>Exporta datos de sensores en diferentes formatos para an√°lisis externo</p>
    </div>

    <!-- Export Form -->
    <div class="export-form-container">
        <form id="exportForm" class="export-form">
            <div class="form-section">
                <h3>üìä Selecci√≥n de Datos</h3>
                
                <div class="form-grid">
                    <!-- Sensor Pattern -->
                    <div class="form-group">
                        <label for="exportPattern">Patr√≥n de Sensores</label>
                        <input type="text" 
                               id="exportPattern" 
                               name="pattern" 
                               placeholder="ej: temperatura.*, *, cpu.servidor_*"
                               list="export-sensor-list"
                               required>
                        <datalist id="export-sensor-list">
                            {{range .Sensors}}
                            <option value="{{.}}">
                            {{end}}
                        </datalist>
                        <small>Usa * como comod√≠n para seleccionar m√∫ltiples sensores</small>
                    </div>

                    <!-- Time Range -->
                    <div class="form-group">
                        <label for="exportStartTime">Fecha/Hora Inicio</label>
                        <input type="datetime-local" 
                               id="exportStartTime" 
                               name="startTime" 
                               required>
                    </div>

                    <div class="form-group">
                        <label for="exportEndTime">Fecha/Hora Fin</label>
                        <input type="datetime-local" 
                               id="exportEndTime" 
                               name="endTime" 
                               required>
                    </div>

                    <!-- Quick Time Ranges -->
                    <div class="form-group">
                        <label>Rangos R√°pidos</label>
                        <div class="quick-ranges">
                            <button type="button" onclick="setExportRange('1h')" class="btn btn-sm">√öltima hora</button>
                            <button type="button" onclick="setExportRange('6h')" class="btn btn-sm">√öltimas 6h</button>
                            <button type="button" onclick="setExportRange('24h')" class="btn btn-sm">√öltimo d√≠a</button>
                            <button type="button" onclick="setExportRange('7d')" class="btn btn-sm">√öltima semana</button>
                            <button type="button" onclick="setExportRange('30d')" class="btn btn-sm">√öltimo mes</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>‚öôÔ∏è Opciones de Exportaci√≥n</h3>
                
                <div class="form-grid">
                    <!-- Format Selection -->
                    <div class="form-group">
                        <label for="exportFormat">Formato de Archivo</label>
                        <div class="format-options">
                            <label class="format-option">
                                <input type="radio" name="format" value="csv" checked>
                                <span class="format-card">
                                    <div class="format-icon">üìÑ</div>
                                    <div class="format-name">CSV</div>
                                    <div class="format-desc">Ideal para Excel y an√°lisis</div>
                                </span>
                            </label>
                            <label class="format-option">
                                <input type="radio" name="format" value="json">
                                <span class="format-card">
                                    <div class="format-icon">üìã</div>
                                    <div class="format-name">JSON</div>
                                    <div class="format-desc">Para aplicaciones y APIs</div>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Include Options -->
                    <div class="form-group">
                        <label>Datos a Incluir</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="includeQuality" checked>
                                <span>Calidad de datos</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="includeMetadata">
                                <span>Metadatos</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="includeTimezone" checked>
                                <span>Zona horaria en timestamps</span>
                            </label>
                        </div>
                    </div>

                    <!-- Filename -->
                    <div class="form-group">
                        <label for="exportFilename">Nombre del Archivo</label>
                        <input type="text" 
                               id="exportFilename" 
                               name="filename" 
                               placeholder="Autom√°tico: export_YYYYMMDD_HHMMSS">
                        <small>D√©jalo vac√≠o para generar autom√°ticamente</small>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="form-section">
                <h3>üëÅÔ∏è Vista Previa</h3>
                <div class="export-preview">
                    <div class="preview-info">
                        <div class="preview-item">
                            <strong>Rango seleccionado:</strong>
                            <span id="preview-range">Selecciona fechas</span>
                        </div>
                        <div class="preview-item">
                            <strong>Sensores estimados:</strong>
                            <span id="preview-sensors">--</span>
                        </div>
                        <div class="preview-item">
                            <strong>Registros estimados:</strong>
                            <span id="preview-records">--</span>
                        </div>
                        <div class="preview-item">
                            <strong>Tama√±o estimado:</strong>
                            <span id="preview-size">--</span>
                        </div>
                    </div>
                    
                    <button type="button" 
                            onclick="generatePreview()" 
                            class="btn btn-secondary">
                        üîç Calcular Vista Previa
                    </button>
                </div>
            </div>

            <!-- Export Actions -->
            <div class="form-actions">
                <button type="button" 
                        onclick="startExport('csv')" 
                        class="btn btn-primary export-btn" 
                        id="csvExportBtn">
                    üìÑ Exportar CSV
                </button>
                <button type="button" 
                        onclick="startExport('json')" 
                        class="btn btn-primary export-btn" 
                        id="jsonExportBtn">
                    üìã Exportar JSON
                </button>
                <button type="button" 
                        onclick="clearExportForm()" 
                        class="btn btn-secondary">
                    üóëÔ∏è Limpiar
                </button>
            </div>
        </form>
    </div>

    <!-- Export Progress -->
    <div id="export-progress" class="export-progress" style="display: none;">
        <div class="progress-header">
            <h3>üîÑ Exportando Datos</h3>
        </div>
        <div class="progress-content">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div class="progress-text">
                <span id="progress-status">Preparando exportaci√≥n...</span>
                <span id="progress-percentage">0%</span>
            </div>
        </div>
    </div>

    <!-- Export History -->
    <div class="export-history">
        <div class="section-header">
            <h3>üìã Historial de Exportaciones</h3>
            <button onclick="clearExportHistory()" class="btn btn-secondary">üóëÔ∏è Limpiar Historial</button>
        </div>
        
        <div class="history-list" id="export-history-list">
            <!-- History items will be populated here -->
        </div>
    </div>

    <!-- Export Templates -->
    <div class="export-templates">
        <h3>üìù Plantillas de Exportaci√≥n</h3>
        <div class="templates-grid">
            <div class="template-card" onclick="loadTemplate('all_sensors')">
                <div class="template-icon">üåê</div>
                <div class="template-name">Todos los Sensores</div>
                <div class="template-desc">Exportar todos los sensores del √∫ltimo d√≠a</div>
            </div>
            
            <div class="template-card" onclick="loadTemplate('temperature_only')">
                <div class="template-icon">üå°Ô∏è</div>
                <div class="template-name">Solo Temperatura</div>
                <div class="template-desc">Todos los sensores de temperatura</div>
            </div>
            
            <div class="template-card" onclick="loadTemplate('weekly_report')">
                <div class="template-icon">üìä</div>
                <div class="template-name">Reporte Semanal</div>
                <div class="template-desc">Datos de la √∫ltima semana para reportes</div>
            </div>
            
            <div class="template-card" onclick="loadTemplate('high_quality')">
                <div class="template-icon">‚úÖ</div>
                <div class="template-name">Solo Datos de Calidad</div>
                <div class="template-desc">Solo datos con calidad 'Buena'</div>
            </div>
        </div>
    </div>
</div>

<script>
// Export page JavaScript
let exportHistory = JSON.parse(localStorage.getItem('exportHistory') || '[]');

document.addEventListener('DOMContentLoaded', function() {
    initializeExportForm();
    loadExportHistory();
    updatePreviewOnChange();
});

function initializeExportForm() {
    // Set default time range (last 24 hours)
    setExportRange('24h');
    
    // Generate default filename
    updateFilename();
    
    // Load sensors count for preview
    updatePreviewInfo();
}

function setExportRange(range) {
    const now = new Date();
    const endTime = new Date(now);
    let startTime = new Date(now);
    
    switch(range) {
        case '1h':
            startTime.setHours(now.getHours() - 1);
            break;
        case '6h':
            startTime.setHours(now.getHours() - 6);
            break;
        case '24h':
            startTime.setDate(now.getDate() - 1);
            break;
        case '7d':
            startTime.setDate(now.getDate() - 7);
            break;
        case '30d':
            startTime.setDate(now.getDate() - 30);
            break;
    }
    
    document.getElementById('exportStartTime').value = formatDateTimeLocal(startTime);
    document.getElementById('exportEndTime').value = formatDateTimeLocal(endTime);
    
    updatePreviewInfo();
}

function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function updateFilename() {
    const now = new Date();
    const timestamp = now.toISOString().slice(0,19).replace(/[:-]/g, '').replace('T', '_');
    document.getElementById('exportFilename').placeholder = `export_${timestamp}`;
}

function updatePreviewOnChange() {
    const form = document.getElementById('exportForm');
    const inputs = form.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('change', updatePreviewInfo);
        input.addEventListener('input', updatePreviewInfo);
    });
}

function updatePreviewInfo() {
    const startTime = document.getElementById('exportStartTime').value;
    const endTime = document.getElementById('exportEndTime').value;
    const pattern = document.getElementById('exportPattern').value || '*';
    
    if (startTime && endTime) {
        const start = new Date(startTime);
        const end = new Date(endTime);
        const duration = end - start;
        const days = duration / (1000 * 60 * 60 * 24);
        
        document.getElementById('preview-range').textContent = 
            `${days.toFixed(1)} d√≠as (${start.toLocaleDateString()} - ${end.toLocaleDateString()})`;
    }
    
    // Estimate sensors (placeholder)
    document.getElementById('preview-sensors').textContent = pattern === '*' ? 'Todos' : 'Filtrados';
    document.getElementById('preview-records').textContent = '~1,000 - 10,000';
    document.getElementById('preview-size').textContent = '~500KB - 5MB';
}

function generatePreview() {
    const formData = new FormData();
    formData.append('pattern', document.getElementById('exportPattern').value || '*');
    formData.append('startTime', document.getElementById('exportStartTime').value);
    formData.append('endTime', document.getElementById('exportEndTime').value);
    
    fetch('/api/export/preview', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('preview-sensors').textContent = data.sensorCount;
        document.getElementById('preview-records').textContent = data.recordCount.toLocaleString();
        document.getElementById('preview-size').textContent = formatBytes(data.estimatedSize);
        showNotification('Vista previa actualizada', 'success');
    })
    .catch(error => {
        showNotification('Error generando vista previa', 'error');
    });
}

function startExport(format) {
    // Disable export buttons
    document.querySelectorAll('.export-btn').forEach(btn => btn.disabled = true);
    
    // Show progress
    document.getElementById('export-progress').style.display = 'block';
    
    // Collect form data
    const formData = new FormData();
    formData.append('pattern', document.getElementById('exportPattern').value || '*');
    formData.append('startTime', document.getElementById('exportStartTime').value);
    formData.append('endTime', document.getElementById('exportEndTime').value);
    formData.append('format', format);
    formData.append('includeQuality', document.querySelector('input[name="includeQuality"]').checked);
    formData.append('includeMetadata', document.querySelector('input[name="includeMetadata"]').checked);
    
    const filename = document.getElementById('exportFilename').value;
    if (filename) {
        formData.append('filename', filename);
    }
    
    // Start export
    const endpoint = format === 'csv' ? '/api/export/csv' : '/api/export/json';
    
    // Simulate progress (in real implementation, use WebSocket or polling)
    simulateExportProgress();
    
    fetch(endpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        // Get filename from Content-Disposition header
        const contentDisposition = response.headers.get('Content-Disposition');
        let downloadFilename = `export_${new Date().toISOString().slice(0,19)}.${format}`;
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename=(.+)/);
            if (filenameMatch) {
                downloadFilename = filenameMatch[1];
            }
        }
        
        return response.blob().then(blob => ({ blob, filename: downloadFilename }));
    })
    .then(({ blob, filename }) => {
        // Download file
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
        
        // Add to history
        addToExportHistory({
            filename: filename,
            format: format,
            size: blob.size,
            timestamp: new Date(),
            pattern: document.getElementById('exportPattern').value,
            records: '~' + document.getElementById('preview-records').textContent
        });
        
        showNotification(`Exportaci√≥n ${format.toUpperCase()} completada`, 'success');
    })
    .catch(error => {
        showNotification('Error en la exportaci√≥n', 'error');
        console.error('Export error:', error);
    })
    .finally(() => {
        // Hide progress and re-enable buttons
        setTimeout(() => {
            document.getElementById('export-progress').style.display = 'none';
            document.querySelectorAll('.export-btn').forEach(btn => btn.disabled = false);
        }, 1000);
    });
}

function simulateExportProgress() {
    let progress = 0;
    const progressFill = document.getElementById('progress-fill');
    const progressStatus = document.getElementById('progress-status');
    const progressPercentage = document.getElementById('progress-percentage');
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) {
            progress = 100;
            clearInterval(interval);
        }
        
        progressFill.style.width = progress + '%';
        progressPercentage.textContent = Math.round(progress) + '%';
        
        if (progress < 25) {
            progressStatus.textContent = 'Consultando base de datos...';
        } else if (progress < 50) {
            progressStatus.textContent = 'Procesando datos...';
        } else if (progress < 75) {
            progressStatus.textContent = 'Generando archivo...';
        } else if (progress < 100) {
            progressStatus.textContent = 'Finalizando...';
        } else {
            progressStatus.textContent = 'Completado';
        }
    }, 200);
}

function addToExportHistory(exportInfo) {
    exportHistory.unshift(exportInfo);
    
    // Keep only last 10 exports
    if (exportHistory.length > 10) {
        exportHistory = exportHistory.slice(0, 10);
    }
    
    localStorage.setItem('exportHistory', JSON.stringify(exportHistory));
    loadExportHistory();
}

function loadExportHistory() {
    const historyList = document.getElementById('export-history-list');
    
    if (exportHistory.length === 0) {
        historyList.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üìã</div>
                <p>No hay exportaciones recientes</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    exportHistory.forEach((item, index) => {
        html += `
            <div class="history-item">
                <div class="history-icon">
                    ${item.format === 'csv' ? 'üìÑ' : 'üìã'}
                </div>
                <div class="history-details">
                    <div class="history-filename">${item.filename}</div>
                    <div class="history-info">
                        <span>${item.format.toUpperCase()}</span>
                        <span>${formatBytes(item.size)}</span>
                        <span>${item.records} registros</span>
                        <span>${new Date(item.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="history-pattern">Patr√≥n: ${item.pattern}</div>
                </div>
                <div class="history-actions">
                    <button onclick="deleteHistoryItem(${index})" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                </div>
            </div>
        `;
    });
    
    historyList.innerHTML = html;
}

function deleteHistoryItem(index) {
    exportHistory.splice(index, 1);
    localStorage.setItem('exportHistory', JSON.stringify(exportHistory));
    loadExportHistory();
}

function clearExportHistory() {
    if (confirm('¬øEliminar todo el historial de exportaciones?')) {
        exportHistory = [];
        localStorage.setItem('exportHistory', JSON.stringify(exportHistory));
        loadExportHistory();
        showNotification('Historial eliminado', 'success');
    }
}

function clearExportForm() {
    document.getElementById('exportForm').reset();
    setExportRange('24h');
    updateFilename();
    updatePreviewInfo();
}

function loadTemplate(templateName) {
    clearExportForm();
    
    switch(templateName) {
        case 'all_sensors':
            document.getElementById('exportPattern').value = '*';
            setExportRange('24h');
            document.querySelector('input[name="includeQuality"]').checked = true;
            break;
            
        case 'temperature_only':
            document.getElementById('exportPattern').value = 'temperatura.*';
            setExportRange('7d');
            document.querySelector('input[name="includeQuality"]').checked = true;
            break;
            
        case 'weekly_report':
            document.getElementById('exportPattern').value = '*';
            setExportRange('7d');
            document.querySelector('input[name="includeQuality"]').checked = true;
            document.querySelector('input[name="includeMetadata"]').checked = true;
            break;
            
        case 'high_quality':
            document.getElementById('exportPattern').value = '*';
            setExportRange('24h');
            document.querySelector('input[name="includeQuality"]').checked = true;
            break;
    }
    
    updatePreviewInfo();
    showNotification(`Plantilla "${templateName}" cargada`, 'success');
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
{{end}}