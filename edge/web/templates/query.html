{{define "query-content"}}
<div class="query-builder">
    <div class="page-header">
        <h1>Constructor de Consultas EdgeSensorWave</h1>
        <p>Explora tus datos de sensores usando la API nativa de EdgeSensorWave</p>
    </div>

    <!-- Query Builder Form -->
    <div class="query-form-container">
        <form id="queryForm" hx-post="/api/query/execute" hx-target="#query-results">
            <div class="form-grid">
                <!-- Sensor Pattern -->
                <div class="form-group">
                    <label for="pattern">Patr√≥n de Sensor</label>
                    <input type="text" 
                           id="pattern" 
                           name="pattern" 
                           placeholder="ej: temperatura.*, cpu.servidor_*"
                           list="sensor-list"
                           required>
                    <datalist id="sensor-list">
                        {{range .Sensors}}
                        <option value="{{.}}">
                        {{end}}
                    </datalist>
                    <small>Usa * como comod√≠n. Ejemplos: temperatura.*, *.salon, cpu.*</small>
                </div>

                <!-- Time Range -->
                <div class="form-group">
                    <label for="startTime">Fecha/Hora Inicio</label>
                    <input type="datetime-local" 
                           id="startTime" 
                           name="startTime" 
                           required>
                </div>

                <div class="form-group">
                    <label for="endTime">Fecha/Hora Fin</label>
                    <input type="datetime-local" 
                           id="endTime" 
                           name="endTime" 
                           required>
                </div>

                <!-- Limit -->
                <div class="form-group">
                    <label for="limit">L√≠mite de Resultados</label>
                    <select id="limit" name="limit">
                        <option value="100">100</option>
                        <option value="500">500</option>
                        <option value="1000" selected>1000</option>
                        <option value="5000">5000</option>
                        <option value="10000">10000</option>
                    </select>
                </div>

                <!-- Quick Time Ranges -->
                <div class="form-group">
                    <label>Rangos R√°pidos</label>
                    <div class="quick-ranges">
                        <button type="button" onclick="setQuickRange('1h')" class="btn btn-sm">√öltima hora</button>
                        <button type="button" onclick="setQuickRange('6h')" class="btn btn-sm">√öltimas 6h</button>
                        <button type="button" onclick="setQuickRange('24h')" class="btn btn-sm">√öltimo d√≠a</button>
                        <button type="button" onclick="setQuickRange('7d')" class="btn btn-sm">√öltima semana</button>
                    </div>
                </div>

                <!-- Format Options -->
                <div class="form-group">
                    <label for="format">Formato de Resultados</label>
                    <select id="format" name="format">
                        <option value="table" selected>Tabla</option>
                        <option value="chart">Gr√°fico</option>
                        <option value="both">Ambos</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    üîç Ejecutar Consulta
                </button>
                <button type="button" onclick="clearForm()" class="btn btn-secondary">
                    üóëÔ∏è Limpiar
                </button>
                <button type="button" onclick="saveQuery()" class="btn btn-secondary">
                    üíæ Guardar Consulta
                </button>
            </div>
        </form>

        <!-- Query Preview -->
        <div class="query-preview">
            <h4>Vista Previa de la Consulta EdgeSensorWave</h4>
            <code id="query-preview-text">
                db.ConsultarRangoConLimite("temperatura.*", startTime, endTime, 1000)
            </code>
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-section">
        <div class="results-header">
            <h3>Resultados</h3>
            <div class="results-actions" id="results-actions" style="display: none;">
                <button onclick="exportResults('csv')" class="btn btn-sm">üìÑ Exportar CSV</button>
                <button onclick="exportResults('json')" class="btn btn-sm">üìã Exportar JSON</button>
                <button onclick="createAlertFromQuery()" class="btn btn-sm">üö® Crear Alerta</button>
            </div>
        </div>

        <div id="query-results" class="results-container">
            <div class="empty-state">
                <div class="empty-icon">üîç</div>
                <h4>No hay resultados</h4>
                <p>Ejecuta una consulta para ver los resultados aqu√≠</p>
            </div>
        </div>
    </div>

    <!-- Saved Queries -->
    <div class="saved-queries">
        <h3>Consultas Guardadas</h3>
        <div class="saved-queries-list" id="saved-queries-list">
            <div class="saved-query-item">
                <span class="query-name">üìä Temperatura √∫ltima hora</span>
                <div class="query-actions">
                    <button onclick="loadSavedQuery('temp_1h')" class="btn btn-sm">Cargar</button>
                    <button onclick="deleteSavedQuery('temp_1h')" class="btn btn-sm btn-danger">Eliminar</button>
                </div>
            </div>
            <div class="saved-query-item">
                <span class="query-name">‚ö° CPU alto uso</span>
                <div class="query-actions">
                    <button onclick="loadSavedQuery('cpu_high')" class="btn btn-sm">Cargar</button>
                    <button onclick="deleteSavedQuery('cpu_high')" class="btn btn-sm btn-danger">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Query Builder JavaScript
let currentResults = null;

// Initialize form when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    updateQueryPreview();
});

function initializeForm() {
    // Set default time range (last hour)
    setQuickRange('1h');
    
    // Add event listeners for real-time preview
    const form = document.getElementById('queryForm');
    const inputs = form.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('change', updateQueryPreview);
        input.addEventListener('input', updateQueryPreview);
    });
}

function setQuickRange(range) {
    const now = new Date();
    const endTime = new Date(now);
    let startTime = new Date(now);
    
    switch(range) {
        case '1h':
            startTime.setHours(now.getHours() - 1);
            break;
        case '6h':
            startTime.setHours(now.getHours() - 6);
            break;
        case '24h':
            startTime.setDate(now.getDate() - 1);
            break;
        case '7d':
            startTime.setDate(now.getDate() - 7);
            break;
    }
    
    // Format for datetime-local input
    document.getElementById('startTime').value = formatDateTimeLocal(startTime);
    document.getElementById('endTime').value = formatDateTimeLocal(endTime);
    
    updateQueryPreview();
}

function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function updateQueryPreview() {
    const pattern = document.getElementById('pattern').value || 'sensor.*';
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const limit = document.getElementById('limit').value;
    
    let query = `// EdgeSensorWave API Call\n`;
    query += `iter, err := db.ConsultarRangoConLimite(\n`;
    query += `    "${pattern}",\n`;
    query += `    ${startTime ? `time.Parse("2006-01-02T15:04", "${startTime}")` : 'startTime'},\n`;
    query += `    ${endTime ? `time.Parse("2006-01-02T15:04", "${endTime}")` : 'endTime'},\n`;
    query += `    ${limit}\n`;
    query += `)`;
    
    document.getElementById('query-preview-text').textContent = query;
}

function clearForm() {
    document.getElementById('queryForm').reset();
    setQuickRange('1h');
    document.getElementById('query-results').innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <h4>No hay resultados</h4>
            <p>Ejecuta una consulta para ver los resultados aqu√≠</p>
        </div>
    `;
    document.getElementById('results-actions').style.display = 'none';
    currentResults = null;
}

// Handle form submission success
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.target.id === 'query-results') {
        try {
            currentResults = JSON.parse(event.target.dataset.results);
            document.getElementById('results-actions').style.display = 'flex';
            renderResults(currentResults);
        } catch (e) {
            // If not JSON, it's probably HTML content
            document.getElementById('results-actions').style.display = 'flex';
        }
    }
});

function renderResults(results) {
    const format = document.getElementById('format').value;
    const container = document.getElementById('query-results');
    
    if (format === 'table' || format === 'both') {
        renderTable(results, container);
    }
    
    if (format === 'chart' || format === 'both') {
        renderChart(results, container);
    }
}

function renderTable(results, container) {
    if (!results || !results.rows || results.rows.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <h4>Sin resultados</h4>
                <p>La consulta no devolvi√≥ ning√∫n resultado</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="results-summary">
            <span>üìä ${results.count} resultados encontrados</span>
            <span>‚ö° Consulta: ${results.query}</span>
        </div>
        <div class="table-container">
            <table class="results-table">
                <thead>
                    <tr>
    `;
    
    // Headers
    results.columns.forEach(col => {
        html += `<th>${col}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    // Rows
    results.rows.forEach(row => {
        html += '<tr>';
        results.columns.forEach(col => {
            let value = row[col];
            if (col === 'value' && typeof value === 'number') {
                value = parseFloat(value).toFixed(2);
            }
            html += `<td>${value}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function renderChart(results, container) {
    if (!results || !results.rows || results.rows.length === 0) {
        return;
    }
    
    // Create chart container
    const chartContainer = document.createElement('div');
    chartContainer.className = 'chart-container';
    chartContainer.innerHTML = '<canvas id="queryChart" width="800" height="400"></canvas>';
    container.appendChild(chartContainer);
    
    // Prepare chart data
    const chartData = {
        labels: [],
        datasets: []
    };
    
    // Group data by sensor
    const sensorData = {};
    results.rows.forEach(row => {
        const sensorId = row.sensor_id;
        if (!sensorData[sensorId]) {
            sensorData[sensorId] = [];
        }
        sensorData[sensorId].push({
            x: new Date(row.timestamp),
            y: parseFloat(row.value)
        });
    });
    
    // Create datasets
    const colors = ['#4CAF50', '#2196F3', '#FF9800', '#F44336', '#9C27B0', '#00BCD4'];
    let colorIndex = 0;
    
    Object.keys(sensorData).forEach(sensorId => {
        chartData.datasets.push({
            label: sensorId,
            data: sensorData[sensorId],
            borderColor: colors[colorIndex % colors.length],
            backgroundColor: colors[colorIndex % colors.length] + '20',
            tension: 0.1,
            pointRadius: 2
        });
        colorIndex++;
    });
    
    // Create chart
    const ctx = document.getElementById('queryChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        displayFormats: {
                            minute: 'HH:mm',
                            hour: 'HH:mm',
                            day: 'MM-DD'
                        }
                    }
                },
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Valor'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

function exportResults(format) {
    if (!currentResults) {
        showNotification('No hay resultados para exportar', 'warning');
        return;
    }
    
    const form = new FormData();
    form.append('pattern', document.getElementById('pattern').value);
    form.append('startTime', document.getElementById('startTime').value);
    form.append('endTime', document.getElementById('endTime').value);
    form.append('format', format);
    form.append('includeQuality', 'true');
    form.append('includeMetadata', 'true');
    
    const endpoint = format === 'csv' ? '/api/export/csv' : '/api/export/json';
    
    fetch(endpoint, {
        method: 'POST',
        body: form
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Error en la exportaci√≥n');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `query_results_${new Date().toISOString().slice(0,19)}.${format}`;
        a.click();
        window.URL.revokeObjectURL(url);
        showNotification(`Exportaci√≥n ${format.toUpperCase()} completada`, 'success');
    })
    .catch(error => {
        showNotification('Error exportando resultados', 'error');
    });
}

function createAlertFromQuery() {
    const pattern = document.getElementById('pattern').value;
    if (!pattern) {
        showNotification('Necesitas un patr√≥n de sensor para crear una alerta', 'warning');
        return;
    }
    
    window.location.href = `/alertas?sensor=${encodeURIComponent(pattern)}`;
}

function saveQuery() {
    const name = prompt('Nombre para la consulta guardada:');
    if (!name) return;
    
    const query = {
        name: name,
        pattern: document.getElementById('pattern').value,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        limit: document.getElementById('limit').value,
        format: document.getElementById('format').value
    };
    
    // Save to localStorage (in a real app, save to server)
    const savedQueries = JSON.parse(localStorage.getItem('savedQueries') || '{}');
    const id = 'query_' + Date.now();
    savedQueries[id] = query;
    localStorage.setItem('savedQueries', JSON.stringify(savedQueries));
    
    showNotification('Consulta guardada exitosamente', 'success');
    loadSavedQueriesList();
}

function loadSavedQuery(queryId) {
    const savedQueries = JSON.parse(localStorage.getItem('savedQueries') || '{}');
    const query = savedQueries[queryId];
    
    if (!query) {
        showNotification('Consulta no encontrada', 'error');
        return;
    }
    
    document.getElementById('pattern').value = query.pattern;
    document.getElementById('startTime').value = query.startTime;
    document.getElementById('endTime').value = query.endTime;
    document.getElementById('limit').value = query.limit;
    document.getElementById('format').value = query.format;
    
    updateQueryPreview();
    showNotification('Consulta cargada', 'success');
}

function deleteSavedQuery(queryId) {
    if (!confirm('¬øEst√°s seguro de eliminar esta consulta?')) return;
    
    const savedQueries = JSON.parse(localStorage.getItem('savedQueries') || '{}');
    delete savedQueries[queryId];
    localStorage.setItem('savedQueries', JSON.stringify(savedQueries));
    
    loadSavedQueriesList();
    showNotification('Consulta eliminada', 'success');
}

function loadSavedQueriesList() {
    const savedQueries = JSON.parse(localStorage.getItem('savedQueries') || '{}');
    const container = document.getElementById('saved-queries-list');
    
    let html = '';
    Object.keys(savedQueries).forEach(id => {
        const query = savedQueries[id];
        html += `
            <div class="saved-query-item">
                <span class="query-name">üìä ${query.name}</span>
                <div class="query-actions">
                    <button onclick="loadSavedQuery('${id}')" class="btn btn-sm">Cargar</button>
                    <button onclick="deleteSavedQuery('${id}')" class="btn btn-sm btn-danger">Eliminar</button>
                </div>
            </div>
        `;
    });
    
    if (html === '') {
        html = '<div class="empty-state"><p>No hay consultas guardadas</p></div>';
    }
    
    container.innerHTML = html;
}

// Load saved queries on page load
document.addEventListener('DOMContentLoaded', loadSavedQueriesList);
</script>
{{end}}